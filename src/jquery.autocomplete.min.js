(function(b){b.Autocompleter=function(a,d){this.cacheData_={};this.cacheLength_=0;this.selectClass_="jquery-autocomplete-selected-item";this.lastSelectedValue_=this.lastProcessedValue_=this.lastKeyPressed_=this.keyTimeout_=null;this.active_=!1;this.finishOnBlur_=!0;if(!a||!(a instanceof jQuery)||1!==a.length||"INPUT"!==a.get(0).tagName.toUpperCase())return window.alert("Invalid parameter for jquery.Autocompleter, jQuery object with one element with INPUT tag expected"),!1;a.attr("autocomplete","off");
this.options="string"===typeof d?{url:d}:d;this.options.minChars=parseInt(this.options.minChars,10);if(isNaN(this.options.minChars)||1>this.options.minChars)this.options.minChars=2;this.options.maxItemsToShow=parseInt(this.options.maxItemsToShow,10);if(isNaN(this.options.maxItemsToShow)||1>this.options.maxItemsToShow)this.options.maxItemsToShow=10;this.options.maxCacheLength=parseInt(this.options.maxCacheLength,10);if(isNaN(this.options.maxCacheLength)||1>this.options.maxCacheLength)this.options.maxCacheLength=
10;this.dom={};this.dom.$elem=a;this.options.inputClass&&this.dom.$elem.addClass(this.options.inputClass);this.dom.$results=b("<div></div>").hide();this.options.resultsClass&&this.dom.$results.addClass(this.options.resultsClass);this.dom.$results.css({position:"absolute"});b("body").append(this.dom.$results);var c=this;a.keydown(function(a){c.lastKeyPressed_=a.keyCode;switch(c.lastKeyPressed_){case 38:return a.preventDefault(),c.active_?c.focusPrev():c.activate(),!1;case 40:return a.preventDefault(),
c.active_?c.focusNext():c.activate(),!1;case 9:if(c.active_&&(c.selectCurrent(),c.options.preventDefaultTab))return a.preventDefault(),!1;break;case 13:if(c.active_&&(c.selectCurrent(),c.options.preventDefaultReturn))return a.preventDefault(),!1;break;case 27:if(c.active_)return a.preventDefault(),c.finish(),!1;break;default:c.activate()}});a.blur(function(){c.finishOnBlur_&&setTimeout(function(){c.finish()},200)})};b.Autocompleter.prototype.position=function(){var a=this.dom.$elem.offset();this.dom.$results.css({top:a.top+
this.dom.$elem.outerHeight(),left:a.left})};b.Autocompleter.prototype.cacheRead=function(a){var d,c,b,f,h;if(this.options.useCache){a=""+a;d=a.length;for(c=this.options.matchSubset?1:d;c<=d;){f=this.options.matchInside?d-c:0;for(h=0;h<=f;){b=a.substr(0,c);if(void 0!==this.cacheData_[b])return this.cacheData_[b];h++}c++}}return!1};b.Autocompleter.prototype.cacheWrite=function(a,d){return this.options.useCache?(this.cacheLength_>=this.options.maxCacheLength&&this.cacheFlush(),a=""+a,void 0!==this.cacheData_[a]&&
this.cacheLength_++,this.cacheData_[a]=d,this.cacheData_[a]):!1};b.Autocompleter.prototype.cacheFlush=function(){this.cacheData_={};this.cacheLength_=0};b.Autocompleter.prototype.callHook=function(a,d){var c=this.options[a];return c&&b.isFunction(c)?c(d,this):!1};b.Autocompleter.prototype.activate=function(){var a=this,d=parseInt(this.options.delay,10);if(isNaN(d)||0>=d)d=250;this.keyTimeout_&&clearTimeout(this.keyTimeout_);this.keyTimeout_=setTimeout(function(){a.activateNow()},d)};b.Autocompleter.prototype.activateNow=
function(){var a=this.beforeUseConverter(this.dom.$elem.val());if(a!==this.lastProcessedValue_&&a!==this.lastSelectedValue_&&a.length>=this.options.minChars)this.lastProcessedValue_=a,this.fetchData(a)};b.Autocompleter.prototype.fetchData=function(a){if(this.options.data)this.filterAndShowResults(this.options.data,a);else{var d=this;this.fetchRemoteData(a,function(c){d.filterAndShowResults(c,a)})}};b.Autocompleter.prototype.fetchRemoteData=function(a,d){var c=this.cacheRead(a);if(c)d(c);else{var e=
this;this.dom.$elem.addClass(this.options.loadingClass);var f=function(c){var b=!1;!1!==c&&(b=e.parseRemoteData(c),e.cacheWrite(a,b));e.dom.$elem.removeClass(e.options.loadingClass);d(b)};b.ajax({url:this.makeUrl(a),success:f,error:function(){f(!1)},dataType:"text"})}};b.Autocompleter.prototype.setExtraParam=function(a,d){var c=b.trim(""+a);if(c){if(!this.options.extraParams)this.options.extraParams={};this.options.extraParams[c]!==d&&(this.options.extraParams[c]=d,this.cacheFlush())}};b.Autocompleter.prototype.makeUrl=
function(a){var d=this,c=this.options.url,e=b.extend({},this.options.extraParams);!1===this.options.queryParamName?c+=encodeURIComponent(a):e[this.options.queryParamName]=a;if(this.options.limitParamName&&this.options.maxItemsToShow)e[this.options.limitParamName]=this.options.maxItemsToShow;var f=[];b.each(e,function(a,c){f.push(d.makeUrlParam(a,c))});f.length&&(c+=-1===c.indexOf("?")?"?":"&",c+=f.join("&"));return c};b.Autocompleter.prototype.makeUrlParam=function(a,d){return[a,encodeURIComponent(d)].join("=")};
b.Autocompleter.prototype.parseRemoteData=function(a){return"json"===this.options.remoteDataType?this.parseRemoteJSON(a):this.parseRemoteText(a)};b.Autocompleter.prototype.parseRemoteText=function(a){for(var d=[],c,b,f,h=(""+a).replace("\r\n",this.options.lineSeparator).split(this.options.lineSeparator),a=0;a<h.length;a++){f=h[a].split(this.options.cellSeparator);b=[];for(c=0;c<f.length;c++)b.push(decodeURIComponent(f[c]));c=b.shift();d.push({value:c,data:b})}return d};b.Autocompleter.prototype.parseRemoteJSON=
function(a){return b.parseJSON(a)};b.Autocompleter.prototype.filterAndShowResults=function(a,b){this.showResults(this.filterResults(a,b),b)};b.Autocompleter.prototype.filterResults=function(a,d){var c=[],e,f,h,g,i;for(h=0;h<a.length;h++){g=a[h];i=typeof g;if("string"===i)e=g,f={};else if(b.isArray(g))e=g[0],f=g.slice(1);else if("object"===i)e=g.value,f=g.data;e=""+e;""<e&&("object"!==typeof f&&(f={}),this.options.filterResults?(g=this.matchStringConverter(d),i=this.matchStringConverter(e),this.options.matchCase||
(g=g.toLowerCase(),i=i.toLowerCase()),g=i.indexOf(g),g=this.options.matchInside?-1<g:0===g):g=!0,g&&c.push({value:e,data:f}))}this.options.sortResults&&(c=this.sortResults(c,d));if(0<this.options.maxItemsToShow&&this.options.maxItemsToShow<c.length)c.length=this.options.maxItemsToShow;return c};b.Autocompleter.prototype.sortResults=function(a,d){var c=this,e=this.options.sortFunction;b.isFunction(e)||(e=function(a,b,d){return c.sortValueAlpha(a,b,d)});a.sort(function(a,c){return e(a,c,d)});return a};
b.Autocompleter.prototype.sortValueAlpha=function(a,b){a=""+a.value;b=""+b.value;this.options.matchCase||(a=a.toLowerCase(),b=b.toLowerCase());return a>b?1:a<b?-1:0};b.Autocompleter.prototype.matchStringConverter=function(a,d,c){var e=this.options.matchStringConverter;b.isFunction(e)&&(a=e(a,d,c));return a};b.Autocompleter.prototype.beforeUseConverter=function(a,d,c){var e=this.options.beforeUseConverter;b.isFunction(e)&&(a=e(a,d,c));return a};b.Autocompleter.prototype.enableFinishOnBlur=function(){this.finishOnBlur_=
!0};b.Autocompleter.prototype.disableFinishOnBlur=function(){this.finishOnBlur_=!1};b.Autocompleter.prototype.showResults=function(a,d){var c=a.length;if(0===c)return this.finish();var e=this,f=b("<ul></ul>"),h,g,i,j=!1,k=!1;for(h=0;h<c;h++)g=a[h],i=b("<li>"+this.showResult(g.value,g.data)+"</li>"),i.data("value",g.value),i.data("data",g.data),i.click(function(){var a=b(this);e.selectItem(a)}).mousedown(e.disableFinishOnBlur).mouseup(e.enableFinishOnBlur),f.append(i),!1===j&&(j=""+g.value,k=i,i.addClass(this.options.firstItemClass)),
h===c-1&&i.addClass(this.options.lastItemClass);this.position();this.dom.$results.html(f).show();f=this.dom.$results.outerWidth()-this.dom.$results.width();this.dom.$results.width(this.dom.$elem.outerWidth()-f);b("li",this.dom.$results).hover(function(){e.focusItem(this)},function(){});(this.autoFill(j,d)||this.options.selectFirst||this.options.selectOnly&&1===c)&&this.focusItem(k);this.active_=!0};b.Autocompleter.prototype.showResult=function(a,d){return b.isFunction(this.options.showResult)?this.options.showResult(a,
d):a};b.Autocompleter.prototype.autoFill=function(a,b){var c,e,f,h;return this.options.autoFill&&8!==this.lastKeyPressed_&&(c=(""+a).toLowerCase(),e=(""+b).toLowerCase(),f=a.length,h=b.length,c.substr(0,h)===e)?(this.dom.$elem.val(a),this.selectRange(h,f),!0):!1};b.Autocompleter.prototype.focusNext=function(){this.focusMove(1)};b.Autocompleter.prototype.focusPrev=function(){this.focusMove(-1)};b.Autocompleter.prototype.focusMove=function(a){for(var d=b("li",this.dom.$results),a=parseInt(a,10),c=0;c<
d.length;c++)if(b(d[c]).hasClass(this.selectClass_)){this.focusItem(c+a);return}this.focusItem(0)};b.Autocompleter.prototype.focusItem=function(a){var d=b("li",this.dom.$results);d.length&&(d.removeClass(this.selectClass_).removeClass(this.options.selectClass),"number"===typeof a?(a=parseInt(a,10),0>a?a=0:a>=d.length&&(a=d.length-1),a=b(d[a])):a=b(a),a&&a.addClass(this.selectClass_).addClass(this.options.selectClass))};b.Autocompleter.prototype.selectCurrent=function(){var a=b("li."+this.selectClass_,
this.dom.$results);1===a.length?this.selectItem(a):this.finish()};b.Autocompleter.prototype.selectItem=function(a){var b=a.data("value"),a=a.data("data"),c=this.displayValue(b,a),e=this.beforeUseConverter(c);this.lastSelectedValue_=this.lastProcessedValue_=e;this.dom.$elem.val(c).focus();this.setCaret(c.length);this.callHook("onItemSelect",{value:b,data:a});this.finish()};b.Autocompleter.prototype.displayValue=function(a,d){return b.isFunction(this.options.displayValue)?this.options.displayValue(a,
d):a};b.Autocompleter.prototype.finish=function(){this.keyTimeout_&&clearTimeout(this.keyTimeout_);this.beforeUseConverter(this.dom.$elem.val())!==this.lastSelectedValue_&&(this.options.mustMatch&&this.dom.$elem.val(""),this.callHook("onNoMatch"));this.dom.$results.hide();this.lastProcessedValue_=this.lastKeyPressed_=null;this.active_&&this.callHook("onFinish");this.active_=!1};b.Autocompleter.prototype.selectRange=function(a,b){var c=this.dom.$elem.get(0);c.setSelectionRange?(c.focus(),c.setSelectionRange(a,
b)):this.createTextRange&&(c=this.createTextRange(),c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",a),c.select())};b.Autocompleter.prototype.setCaret=function(a){this.selectRange(a,a)};b.fn.autocomplete=function(a){"string"===typeof a&&(a={url:a});var d=b.extend({},b.fn.autocomplete.defaults,a);return this.each(function(){var a=b(this),e=new b.Autocompleter(a,d);a.data("autocompleter",e)})};b.fn.autocomplete.defaults={inputClass:"acInput",loadingClass:"acLoading",resultsClass:"acResults",
selectClass:"acSelect",queryParamName:"q",limitParamName:"limit",extraParams:{},remoteDataType:!1,lineSeparator:"\n",cellSeparator:"|",minChars:2,maxItemsToShow:10,delay:400,useCache:!0,maxCacheLength:10,matchSubset:!0,matchCase:!1,matchInside:!0,mustMatch:!1,selectFirst:!1,selectOnly:!1,showResult:null,preventDefaultReturn:!0,preventDefaultTab:!1,autoFill:!1,filterResults:!0,sortResults:!0,sortFunction:null,onItemSelect:null,onNoMatch:null,onFinish:null,matchStringConverter:null,beforeUseConverter:null}})(jQuery);